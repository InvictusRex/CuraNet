<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CuraNet - Patient Dashboard</title>
    <link rel="stylesheet" href="../assets/css/global.css" />
    <link rel="stylesheet" href="../assets/css/dashboard.css" />
  </head>
  <body>
    <a href="/" class="brand-logo">CuraNet HMS</a>

    <button
      class="theme-toggle"
      onclick="toggleTheme()"
      aria-label="Toggle theme"
    >
      <svg
        class="sun-icon"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
      >
        <path
          d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"
        />
      </svg>
    </button>



    <div class="dashboard-container">
      <aside class="sidebar">
        <div class="sidebar-header"></div>

        <div class="user-info">
          <div class="user-avatar" id="userAvatar">
            <!-- Will be filled by JS -->
          </div>
          <h3 id="userName">Loading...</h3>
          <p id="patientId">Loading...</p>
        </div>

        <ul class="nav-menu">
          <li><a href="#" class="active">Dashboard</a></li>
          <!--<li><a href="#appointments">My Appointments</a></li>-->
          <li><a href="patient-profile.html">Profile</a></li>
          <li><a href="patient-medical-history.html">Medical History</a></li>
          <li><a href="doctor-list.html">Find Doctors</a></li>
          <li><a href="/">Logout</a></li>
        </ul>
      </aside>

      <main class="main-content">
        <div class="dashboard-header">
          <h1 class="dashboard-title">Patient Dashboard</h1>
          <button class="btn-primary" data-modal="bookAppointmentModal">
            Book Appointment
          </button>
        </div>

        <div class="dashboard-cards">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Upcoming Appointments</h3>
            </div>
            <div class="card-body">
              <h2>2</h2>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Prescriptions</h3>
            </div>
            <div class="card-body">
              <h2>3</h2>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Lab Reports</h3>
            </div>
            <div class="card-body">
              <h2>5</h2>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Medical History</h3>
          </div>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Appointment ID</th>
                  <th>Date / Time</th>
                  <th>Doctor</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="recentAppointmentsTable">
                <!-- Will be filled dynamically by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <!-- Book Appointment Modal -->
    <div class="modal" id="bookAppointmentModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Book Appointment</h2>
          <button class="close-modal">&times;</button>
        </div>
        <form id="appointmentForm">
          <div class="form-group">
            <label for="appointmentDateTime">Date and Time</label>
            <input type="datetime-local" id="appointmentDateTime" required />
          </div>
          <div class="form-group">
            <label for="doctorSelect">Select Doctor</label>
            <select id="doctorSelect" required>
              <option value="">Select Doctor</option>
              <!-- Will be populated dynamically -->
            </select>
          </div>
          <button type="submit" class="btn-primary">Book Appointment</button>
        </form>
      </div>
    </div>

    <script src="../assets/js/common.js"></script>
    <script>
      // Function to load dashboard header info
      async function loadDashboardInfo() {
        try {
          const username = localStorage.getItem("username");
          if (!username) {
            window.location.href = "../index.html";
            return;
          }

          const response = await fetch(
            `/patient/dashboard-info/${username}`
          );
          if (!response.ok) {
            throw new Error("Failed to fetch dashboard info");
          }

          const data = await response.json();

          // Update user info
          document.getElementById("userName").textContent = data.name;
          document.getElementById("patientId").textContent = data.patient_id;
          document.getElementById("userAvatar").textContent =
            data.name[0].toUpperCase();

          // Update recent appointments table
          const tableBody = document.getElementById("recentAppointmentsTable");
          tableBody.innerHTML = "";

          if (data.recent_appointments && data.recent_appointments.length > 0) {
            data.recent_appointments.forEach((appointment) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${appointment.appointment_id}</td>
                <td>${appointment.date_time}</td>
                <td>${appointment.doctor}</td>
                <td>${appointment.status}</td>
              `;
              tableBody.appendChild(row);
            });
          } else {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td colspan="4" style="text-align: center;">No recent appointments found</td>
            `;
            tableBody.appendChild(row);
          }
        } catch (error) {
          console.error("Error loading dashboard info:", error);
          alert("Failed to load dashboard information");
        }
      }

      // Load dashboard info when page loads
      document.addEventListener("DOMContentLoaded", loadDashboardInfo);



      // Modal functionality
      document.querySelectorAll("[data-modal]").forEach((button) => {
        button.addEventListener("click", () => {
          const modalId = button.getAttribute("data-modal");
          document.getElementById(modalId).style.display = "flex";
        });
      });

      document.querySelectorAll(".close-modal").forEach((button) => {
        button.addEventListener("click", () => {
          button.closest(".modal").style.display = "none";
        });
      });

      // Close modal when clicking outside
      window.addEventListener("click", (event) => {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      });

      // Fetch doctors for dropdown
      async function fetchDoctors() {
        try {
          const response = await fetch(
            "/admin/doctors-list"
          );
          const doctors = await response.json();
          const select = document.getElementById("doctorSelect");
          select.innerHTML = '<option value="">Select Doctor</option>';
          doctors.forEach((doctor) => {
            select.innerHTML += `<option value="${doctor.id}">${doctor.name} (${doctor.department})</option>`;
          });
        } catch (error) {
          console.error("Error fetching doctors:", error);
        }
      }

      // Add appointment form submission handler
      document
        .getElementById("appointmentForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const dateTimeInput = document.getElementById(
            "appointmentDateTime"
          ).value;
          const formattedDateTime = dateTimeInput.replace("T", " ") + ":00";

          const formData = {
            patient_id: parseInt(localStorage.getItem("user_id")),
            doctor_id: parseInt(document.getElementById("doctorSelect").value),
            appointment_time: formattedDateTime,
            status: "pending", // Hardcoded to pending for patients
          };

          try {
            const response = await fetch(
              "/admin/appointment",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
              }
            );

            if (response.ok) {
              document.getElementById("bookAppointmentModal").style.display =
                "none";
              e.target.reset();
              await loadDashboardInfo(); // Refresh the list
              alert("Appointment booked successfully!");
            } else {
              const errorData = await response.json();
              alert(
                `Error booking appointment: ${
                  errorData.detail || "Unknown error"
                }`
              );
            }
          } catch (error) {
            console.error("Error booking appointment:", error);
            alert("Failed to book appointment. Please try again.");
          }
        });

      // Initialize doctors dropdown when opening modal
      document
        .querySelector('[data-modal="bookAppointmentModal"]')
        .addEventListener("click", () => {
          fetchDoctors();
        });
    </script>
  </body>
</html>
